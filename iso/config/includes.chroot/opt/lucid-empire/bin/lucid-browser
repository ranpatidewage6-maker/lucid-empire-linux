#!/bin/bash
# LUCID EMPIRE TITAN - Browser Launcher
# Launches Camoufox with active profile and full anti-detection

set -e

TITAN_HOME="${TITAN_HOME:-/opt/lucid-empire}"
PROFILES_DIR="${HOME}/.lucid-empire/profiles"
ACTIVE_DIR="${PROFILES_DIR}/active"
CAMOUFOX_DIR="${TITAN_HOME}/camoufox"
LOG_DIR="${HOME}/.lucid-empire/logs"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log() { echo -e "${GREEN}[TITAN]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

mkdir -p "$LOG_DIR"

# Check for active profile
if [[ ! -f "$ACTIVE_DIR/profile.json" ]]; then
    error "No active profile loaded"
    echo ""
    echo "Create and load a profile first:"
    echo "  lucid-profile-mgr create my_profile 90"
    echo "  lucid-profile-mgr load my_profile"
    exit 1
fi

# Read profile data
PROFILE_JSON="$ACTIVE_DIR/profile.json"
PROFILE_NAME=$(jq -r '.profile_name' "$PROFILE_JSON")
PROFILE_ID=$(jq -r '.profile_id' "$PROFILE_JSON")
AGING_DAYS=$(jq -r '.aging_days // 90' "$PROFILE_JSON")
USER_AGENT=$(jq -r '.browser.user_agent // ""' "$PROFILE_JSON")
TIMEZONE=$(jq -r '.location.timezone // "UTC"' "$PROFILE_JSON")
LOCALE=$(jq -r '.location.locale // "en-US"' "$PROFILE_JSON")
LATITUDE=$(jq -r '.location.latitude // 0' "$PROFILE_JSON")
LONGITUDE=$(jq -r '.location.longitude // 0' "$PROFILE_JSON")
PROXY=$(jq -r '.network.proxy // null' "$PROFILE_JSON")
RESOLUTION_W=$(jq -r '.browser.resolution.width // 1920' "$PROFILE_JSON")
RESOLUTION_H=$(jq -r '.browser.resolution.height // 1080' "$PROFILE_JSON")

log "╔═══════════════════════════════════════════════════════════╗"
log "║        LUCID EMPIRE TITAN - Browser Launch                ║"
log "╚═══════════════════════════════════════════════════════════╝"
log "Profile: $PROFILE_NAME"
log "ID: ${PROFILE_ID:0:8}..."
log "Age: $AGING_DAYS days"
log "Timezone: $TIMEZONE"

# Browser profile directory
BROWSER_PROFILE_DIR="${ACTIVE_DIR}/browser"
mkdir -p "$BROWSER_PROFILE_DIR"

# Calculate time offset for libfaketime
TIME_OFFSET="-${AGING_DAYS}d"
if [[ -f "$ACTIVE_DIR/time_offset" ]]; then
    TIME_OFFSET=$(cat "$ACTIVE_DIR/time_offset")
fi

# Find libfaketime
LIBFAKETIME=""
for lib in \
    "/usr/lib/x86_64-linux-gnu/faketime/libfaketime.so.1" \
    "/usr/lib/faketime/libfaketime.so.1" \
    "/usr/local/lib/faketime/libfaketime.so.1"; do
    if [[ -f "$lib" ]]; then
        LIBFAKETIME="$lib"
        break
    fi
done

# Set environment for temporal displacement
if [[ -n "$LIBFAKETIME" ]]; then
    log "Temporal displacement: $TIME_OFFSET"
    export LD_PRELOAD="$LIBFAKETIME"
    export FAKETIME="$TIME_OFFSET"
    export FAKETIME_DONT_FAKE_MONOTONIC=1
    export FAKETIME_NO_CACHE=1
else
    warn "libfaketime not found - profile aging disabled"
fi

# Set timezone
export TZ="$TIMEZONE"

# Geolocation override (for browser)
export LUCID_GEO_LAT="$LATITUDE"
export LUCID_GEO_LON="$LONGITUDE"

# Find browser binary
BROWSER_BIN=""
BROWSER_TYPE="camoufox"

if [[ -x "$CAMOUFOX_DIR/camoufox" ]]; then
    BROWSER_BIN="$CAMOUFOX_DIR/camoufox"
elif [[ -x "$CAMOUFOX_DIR/firefox" ]]; then
    BROWSER_BIN="$CAMOUFOX_DIR/firefox"
elif command -v camoufox &>/dev/null; then
    BROWSER_BIN=$(command -v camoufox)
elif command -v firefox &>/dev/null; then
    BROWSER_BIN=$(command -v firefox)
    BROWSER_TYPE="firefox"
else
    error "No browser found. Install with: $TITAN_HOME/install-camoufox.sh"
    exit 1
fi

log "Browser: $BROWSER_BIN ($BROWSER_TYPE)"

# Create Firefox/Camoufox user.js for profile injection
cat > "$BROWSER_PROFILE_DIR/user.js" << USERJS
// LUCID EMPIRE TITAN - Profile Configuration
// Profile: $PROFILE_NAME
// Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)

// User Agent
user_pref("general.useragent.override", "$USER_AGENT");

// Timezone
user_pref("intl.accept_languages", "$LOCALE");

// Screen Resolution
user_pref("privacy.window.maxInnerWidth", $RESOLUTION_W);
user_pref("privacy.window.maxInnerHeight", $RESOLUTION_H);

// Geolocation spoofing
user_pref("geo.enabled", true);
user_pref("geo.provider.testing", true);
user_pref("geo.provider.testing.latitude", $LATITUDE);
user_pref("geo.provider.testing.longitude", $LONGITUDE);

// Disable telemetry
user_pref("toolkit.telemetry.enabled", false);
user_pref("toolkit.telemetry.unified", false);
user_pref("datareporting.healthreport.uploadEnabled", false);
user_pref("datareporting.policy.dataSubmissionEnabled", false);

// Disable safe browsing
user_pref("browser.safebrowsing.enabled", false);
user_pref("browser.safebrowsing.malware.enabled", false);
user_pref("browser.safebrowsing.phishing.enabled", false);

// WebRTC leak prevention
user_pref("media.peerconnection.enabled", true);
user_pref("media.peerconnection.ice.default_address_only", true);
user_pref("media.peerconnection.ice.no_host", true);
user_pref("media.peerconnection.ice.proxy_only_if_behind_proxy", true);

// Canvas/WebGL fingerprinting (TITAN handles this externally)
user_pref("privacy.resistFingerprinting", false);
user_pref("webgl.enable-debug-renderer-info", true);

// Performance
user_pref("network.http.max-connections", 256);
user_pref("network.http.max-persistent-connections-per-server", 8);
USERJS

# Proxy configuration
if [[ "$PROXY" != "null" ]] && [[ -n "$PROXY" ]]; then
    log "Proxy: $PROXY"
    # Parse proxy URL
    PROXY_HOST=$(echo "$PROXY" | sed -E 's|.*://([^:]+):.*|\1|')
    PROXY_PORT=$(echo "$PROXY" | sed -E 's|.*:([0-9]+).*|\1|')
    PROXY_TYPE="socks5"
    
    cat >> "$BROWSER_PROFILE_DIR/user.js" << PROXY_PREF

// Proxy Configuration
user_pref("network.proxy.type", 1);
user_pref("network.proxy.socks", "$PROXY_HOST");
user_pref("network.proxy.socks_port", $PROXY_PORT);
user_pref("network.proxy.socks_remote_dns", true);
PROXY_PREF
else
    warn "No proxy configured - using direct connection"
fi

# Build browser arguments
BROWSER_ARGS=(
    "--profile" "$BROWSER_PROFILE_DIR"
    "--no-remote"
)

# Window size
BROWSER_ARGS+=("--width" "$RESOLUTION_W" "--height" "$RESOLUTION_H")

# Additional Camoufox-specific args
if [[ "$BROWSER_TYPE" == "camoufox" ]]; then
    BROWSER_ARGS+=("--new-instance")
fi

# Launch browser
log "Launching browser..."
log "─────────────────────────────────────────────────────────────"

# Log session start
SESSION_LOG="$LOG_DIR/session_$(date +%Y%m%d_%H%M%S).log"
{
    echo "Session Start: $(date)"
    echo "Profile: $PROFILE_NAME"
    echo "Browser: $BROWSER_BIN"
    echo "Time Offset: $TIME_OFFSET"
    echo "Timezone: $TIMEZONE"
} > "$SESSION_LOG"

# Launch
exec "$BROWSER_BIN" "${BROWSER_ARGS[@]}" 2>> "$SESSION_LOG"
